<!DOCTYPE html>
<html>
<head>
    <title>Structural Time Series in PyMC!</title>
    <meta charset='UTF-8'>
    <meta content='width=device-width, initial-scale=1' name='viewport'/>
    <meta name='description' content='Gregory Gundersen is a PhD candidate at Princeton.'>
    <meta name='keywords' content=''>
    <meta name='author' content='Gregory Gundersen'>
    
    <link href='/css/blog.css' rel='stylesheet'/>
    <link href='/css/trac.css' rel='stylesheet'/>
    <link href='/css/markdown.css' rel='stylesheet'/>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\\[", right: "\\]", display: true},
                    {left: "\\(", right: "\\)", display: false}
                ],
                throwOnError: false
            });
        });
    </script>
    
    <script type='text/x-mathjax-config'>
MathJax.Hub.Config({
  jax: ['input/TeX', 'output/HTML-CSS'],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    extensions: ['color.js']
  },
  messageStyle: 'none',
  'HTML-CSS': { preferredFont: 'TeX', availableFonts: ['STIX','TeX'] }
});
</script>

<script src='//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML' type='text/javascript'></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
</head>
<body>
    <div class='content'>
        <div class='nav'>
    <ul class='wrap'>
        <li><a href='/'>Home</a></li>
        <li><a href='/blog'>Blog</a></li>
        <li><a href='/feed.xml'>RSS</a></li>
    </ul>
</div>
        <div class='front-matter'>
            <div class='wrap'>
                <h1>Structural Time Series in PyMC!</h1>
                <h4></h4>
                <div class='bylines'>
                    <div class='byline'>
                        <h3>Published</h3>
                        <p>13 August 2021</p>
                    </div>
                </div>
                <div class='clear'></div>
            </div>
        </div>
        <div class='wrap article'>
            
            <p>Bayesian Structural Time Series let us model time series component by component. Hereâ€™s how to do it in PyMC.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pylab</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="n">mdates</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="n">pm</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="n">az</span>

<span class="kn">from</span> <span class="nn">pandas.plotting</span> <span class="kn">import</span> <span class="n">register_matplotlib_converters</span>
<span class="n">register_matplotlib_converters</span><span class="p">()</span>

<span class="n">sns</span><span class="p">.</span><span class="n">set_context</span><span class="p">(</span><span class="s">"notebook"</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="n">set_style</span><span class="p">(</span><span class="s">"darkgrid"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">passengers</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'passengers.csv'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">';'</span><span class="p">)</span>
<span class="n">passengers</span><span class="p">[</span><span class="s">'Passengers'</span><span class="p">]</span> <span class="o">=</span> <span class="n">passengers</span><span class="p">[</span><span class="s">'Passengers'</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">passengers</span><span class="p">[</span><span class="s">'Month'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">passengers</span><span class="p">[</span><span class="s">'Month'</span><span class="p">])</span>
<span class="n">passengers</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Month'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">passengers</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x134a79d50&gt;
</code></pre></div></div>

<p><img src="2021-08-13-Structural%20Time%20Series%20in%20PyMC3_files/2021-08-13-Structural%20Time%20Series%20in%20PyMC3_1_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">passengers</span><span class="p">[</span><span class="s">'Passengers'</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>112.0
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="n">Model</span><span class="p">():</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">GaussianRandomWalk</span><span class="p">(</span><span class="s">'delta'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">144</span><span class="p">,))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">GaussianRandomWalk</span><span class="p">(</span><span class="s">'mu'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">143</span><span class="p">,),</span> <span class="n">observed</span><span class="o">=</span><span class="n">passengers</span><span class="p">[</span><span class="s">'Passengers'</span><span class="p">])</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [delta]
</code></pre></div></div>

<div>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;style&gt;
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
&lt;/style&gt;
</code></pre></div>  </div>
  <progress value="24000" class="" max="24000" style="width:300px; height:20px; vertical-align: middle;"></progress>
  <p>100.00% [24000/24000 00:11&lt;00:00 Sampling 4 chains, 0 divergences]</p>
</div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sampling 4 chains for 1_000 tune and 5_000 draw iterations (4_000 + 20_000 draws total) took 20 seconds.
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/tomkealy/opt/anaconda3/lib/python3.7/site-packages/arviz/data/io_pymc3.py:91: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  FutureWarning,
/Users/tomkealy/opt/anaconda3/lib/python3.7/site-packages/arviz/plots/traceplot.py:195: UserWarning: rcParams['plot.max_subplots'] (20) is smaller than the number of variables to plot (144), generating only 20 plots
  UserWarning,





array([[&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132062690&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x13210eed0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x134d33350&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1321ceed0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x13595a9d0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132154a90&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x13229f650&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132384b50&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1323c2f90&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1324bc7d0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1324fcb50&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1325eaed0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132639bd0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132727cd0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132773850&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132862d10&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1328a6fd0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x13299d990&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1329e0c10&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132ad8610&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132b1ad90&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132c08f50&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132c91a10&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132d57ad0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132da6690&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132e96b50&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132ed8f50&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132fcf7d0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x133014b50&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x133101ed0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x13314dbd0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x13323ccd0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1332d0850&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x133395d10&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1333d9fd0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1334cf990&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x133511c10&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x13360c610&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x13364cd90&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x133739f50&gt;]],
      dtype=object)
</code></pre></div></div>

<p><img src="2021-08-13-Structural%20Time%20Series%20in%20PyMC3_files/2021-08-13-Structural%20Time%20Series%20in%20PyMC3_4_2.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_forecast</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span>
                  <span class="n">col_name</span><span class="p">,</span>
                  <span class="n">forecast_start</span><span class="p">,</span>
                  <span class="n">forecast_mean</span><span class="p">,</span> 
                  <span class="n">forecast_scale</span><span class="p">,</span> 
                  <span class="n">forecast_samples</span><span class="p">,</span>
                  <span class="n">title</span><span class="p">,</span> 
                  <span class="n">x_locator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                  <span class="n">x_formatter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">"""Plot a forecast distribution against the 'true' time series."""</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="n">color_palette</span><span class="p">()</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">.</span><span class="n">index</span>

    <span class="n">num_steps</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_steps_forecast</span> <span class="o">=</span> <span class="n">forecast_mean</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">num_steps_train</span> <span class="o">=</span> <span class="n">num_steps</span> <span class="o">-</span> <span class="n">num_steps_forecast</span>

    <span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'ground truth'</span><span class="p">)</span>

    <span class="n">forecast_steps</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">forecast_start</span><span class="p">:].</span><span class="n">index</span>

    <span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast_steps</span><span class="p">,</span> 
            <span class="n">forecast_samples</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> 
            <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
            <span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span> 
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast_steps</span><span class="p">,</span> 
            <span class="n">forecast_mean</span><span class="p">,</span> 
            <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
            <span class="n">ls</span><span class="o">=</span><span class="s">'--'</span><span class="p">,</span> 
            <span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s">'forecast'</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">forecast_steps</span><span class="p">,</span>
                   <span class="n">forecast_mean</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">forecast_scale</span><span class="p">,</span>
                   <span class="n">forecast_mean</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">forecast_scale</span><span class="p">,</span> 
                   <span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span> 
                   <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">forecast_samples</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">forecast_samples</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">yrange</span> <span class="o">=</span> <span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">ymin</span> <span class="o">-</span> <span class="n">yrange</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">yrange</span><span class="o">*</span><span class="mf">0.1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_forecast</span><span class="p">(</span>
    <span class="n">passengers</span><span class="p">,</span>
    <span class="s">'Passengers'</span><span class="p">,</span>
    <span class="s">'1959-01-01'</span><span class="p">,</span>
    <span class="n">forecast_mean</span><span class="p">,</span> 
    <span class="n">forecast_scale</span><span class="p">,</span> 
    <span class="n">forecast_samples</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s">'Airplane Passenger Numbers'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">"upper left"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">"Passenger Numbers"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">"Month"</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

&lt;ipython-input-4-d3135643ac66&gt; in &lt;module&gt;
     54     'Passengers',
     55     '1959-01-01',
---&gt; 56     forecast_mean,
     57     forecast_scale,
     58     forecast_samples,


NameError: name 'forecast_mean' is not defined
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

        </div>
        
    </div>
</body>
</html>
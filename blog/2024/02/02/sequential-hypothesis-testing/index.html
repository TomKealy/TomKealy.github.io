<!DOCTYPE html>
<html>
<head>
    <title>Sequential Hypothesis Testing</title>
    <meta charset='UTF-8'>
    <meta content='width=device-width, initial-scale=1' name='viewport'/>
    <meta name='description' content='Gregory Gundersen is a PhD candidate at Princeton.'>
    <meta name='keywords' content=''>
    <meta name='author' content='Gregory Gundersen'>
    
    <link href='/css/blog.css' rel='stylesheet'/>
    <link href='/css/trac.css' rel='stylesheet'/>
    <link href='/css/markdown.css' rel='stylesheet'/>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\\[", right: "\\]", display: true},
                    {left: "\\(", right: "\\)", display: false}
                ],
                throwOnError: false
            });
        });
    </script>
    
    <script type='text/x-mathjax-config'>
MathJax.Hub.Config({
  jax: ['input/TeX', 'output/HTML-CSS'],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    extensions: ['color.js']
  },
  messageStyle: 'none',
  'HTML-CSS': { preferredFont: 'TeX', availableFonts: ['STIX','TeX'] }
});
</script>

<script src='//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML' type='text/javascript'></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
</head>
<body>
    <div class='content'>
        <div class='nav'>
    <ul class='wrap'>
        <li><a href='/'>Home</a></li>
        <li><a href='/blog'>Blog</a></li>
        <li><a href='/feed.xml'>RSS</a></li>
    </ul>
</div>
        <div class='front-matter'>
            <div class='wrap'>
                <h1>Sequential Hypothesis Testing</h1>
                <h4></h4>
                <div class='bylines'>
                    <div class='byline'>
                        <h3>Published</h3>
                        <p>02 February 2024</p>
                    </div>
                </div>
                <div class='clear'></div>
            </div>
        </div>
        <div class='wrap article'>
            <p>We introduce the mSPRT and give a derivation from a Bayesian point of view.</p>

<h1 id="sequential-testing">Sequential Testing</h1>

<p>Normally when you go about hypothesis testing, after a random sample is observed one of two possible actions are taken: accept the null hypothesis \(H_0\), or accepct the tive hypothesis \(H_1\). In some cases the evidence may strongly support one of the hypotheses, whilst in other cases the evidence may be less convincing. Nevertheless, a decision must he made. All this assumes that all the data has been collected, and no more is available. It doesn’t have to be this way. There is a class of hypothesis tests where you can safely collect more data when the evidence is ambiguous. Such a test typically continues until the evidence strongly favors one of the two hypotheses.</p>

<p>In case of simple hypotheses the strength of the evidence for \(H\) is given by the ratio of the probability of the data under \(H_0\), to the probability of the data under \(H_1\). We denote this likelihood ratio by \(\Lambda\). The Neyman-Pearson lemma implies that for a given amount of information the likelihood ratio test is the most powerful test. Such a rule decides to accept \(H_1\) if \(\Lambda\) is big enough, and decides to accept \(H_0\) otherwise. How big \(\Lambda\) must get to lead to the decicion \(H_1\), danends on, amond other things, its sampling distribution under \(H_0\) and \(H_1\). It is not unusual for “big enough” to mean \(\Lambda \geq 1\). Such tests could easily decide \(H_0\) or \(H_1\) when the actual evidence is neutral.</p>

<h2 id="sprt">SPRT</h2>

<p>In 1943 Wald proposed the <em>sequential probability ratio test</em> (SPRT). Suppose that \(Y\) is a random variable with unknown distribution \(f\). We want to test the following hypotheses:</p>

<ul>
  <li>
\[H_0: f=f_0\]
  </li>
  <li>
\[H_1: f=f_1\]
  </li>
</ul>

<p>where \(f_0\) and \(f_1\) are specified. We observe values of \(Y\) successively: \(y_1, y_2, \ldots\) the random variables \(Y_i\) corresponding to the \(y_i\) are i.i.d with common distribution \(f\). Let</p>

\[\Lambda = \prod_{i=1}^n \frac{f_1\left(x_i\right)}{f_0\left(x_i\right)}\]

<p>be the likelihood ratio at stage \(n\). We choose two decision boundaries \(A\) and \(B\) such that \(0 &lt; B &lt; A &lt; \infty\),  we accept \(H_0\) if \(\Lambda \leq B\) and \(H_1\) if \(\Lambda \geq A\), and we continue if \(B \leq \Lambda \leq A\). The constants \(A\) and \(B\) are determined by the desired false positive and false negative rates of the experimenter. In general it can  be shown that the boundaries A and B can be calculated as with very good approximation as</p>

\[A=\log\left(\frac{\beta}{1=\alpha}\right)\]

\[B=\log\left(\frac{1-\beta}{\alpha}\right)\]

<p>so the SPRT is really very simple to apply in practice.</p>

<h3 id="example-iid-case">Example: IID case</h3>

<p>Assume that \(X_1 , X_2 \ldots\) are independent and identically distributed with distributions \(P\), and \(Q\), under \(H_0\) and \(H_1\) respectively. Then \(L_n =\Lambda\left(X_n\right)\). Let \(Z_i=\log{\left(\Lambda\left(X_n\right)\right)}\). Since \(\log{L_n} = \sum_i^n Z_i\) the SPRT can be viewed as z random walk (or more properly a family of random walks), with steps \(Z_i\) which proceeds until it crosses \(\log{B}\) or \(\log{A}\).</p>

<p>We now focus on the more general case where \(P\) and \(Q\), have either densities or probability mass functions of the form:</p>

\[f\left(x; \theta\right) = h\left(x\right)\exp{C\left(\theta\right)x - D\left(\theta\right)}\]

<p>where \(\theta\) is a real valued parameter. The <em>exponential families</em> are to work with and include many common distributions. Let \(P\), be determined by \(f\left(x; \theta_0\right)\), and let \(Q\), be determined by \(f\left(x; \theta_1\right)\). Then 
\(Z_i = \left[C\left(\theta_1\right) - C\left(\theta_0\right) \right]X_i - \left[D\left(\theta_1\right)-D\left(\theta_0\right)\right]\).</p>

<p>In terms of the random walk with steps \(Z_i\) the SPRT continues until fixed boundaries are crossed.</p>

<p>It is somtimes easier to perform the test using the sums of the \(X_i\)’s. Let \(S_n = \sum X_i\). Assuming that \(C\left(\theta_1\right) &gt; C\left(\theta_0\right)\) the test continues until</p>

\[S_n \geq \frac{ \log{A} }{ C\left(\theta_1\right) - C\left(\theta_0\right) } + n\frac{ D\left(\theta_1\right)-D\left(\theta_0\right) }{ C\left(\theta_1\right) - C\left(\theta_0\right) }\]

<p>Or</p>

\[S_n \leq \frac{ \log{A} }{ C\left(\theta_1\right) - C\left(\theta_0\right) } + n\frac{ D\left(\theta_1\right)-D\left(\theta_0\right) }{ C\left(\theta_1\right) - C\left(\theta_0\right) }\]

<p>The following tableshow the SPRT for some common distributions:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Distribution</th>
      <th style="text-align: right">\(f\left(x; \theta\right)\)</th>
      <th style="text-align: right">\(C\left(\theta\right)\)</th>
      <th style="text-align: right">\(D\left(\theta\right)\)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Normal</td>
      <td style="text-align: right">\(\frac{1}{\sqrt{2\pi}}e^\left(-\left(x-\theta\right)^2/2\right)\)</td>
      <td style="text-align: right">\(\theta\)</td>
      <td style="text-align: right">\(\frac{\theta^2}{2}\)</td>
    </tr>
    <tr>
      <td style="text-align: left">Bernoulli</td>
      <td style="text-align: right">\(\theta^{x}\left(1-\theta\right)^{(1-x)}\)</td>
      <td style="text-align: right">\(\log{\left(\frac{\theta}{1-\theta}\right)}\)</td>
      <td style="text-align: right">\(-\log{\left(1-\theta\right)}\)</td>
    </tr>
    <tr>
      <td style="text-align: left">Exponential</td>
      <td style="text-align: right">\(\frac{1}{\theta}e^-x/\theta\)</td>
      <td style="text-align: right">\(\log{\theta}\)</td>
      <td style="text-align: right">\(\theta\)</td>
    </tr>
    <tr>
      <td style="text-align: left">Poisson</td>
      <td style="text-align: right">\(\frac{e^-\theta \theta^x}{x!}\)</td>
      <td style="text-align: right">\(-\frac{1}{\theta}\)</td>
      <td style="text-align: right">\(\log{\theta}\)</td>
    </tr>
  </tbody>
</table>

<h3 id="example-exponential-distribution">Example: Exponential Distribution</h3>

<p>A textbook example is parameter estimation of a probability distribution function. Consider the exponential distribution:</p>

\[f\left(x; \theta\right) = \frac{1}{\theta}e^-x/\theta\]

<p>The hypotheses are</p>

<ul>
  <li>
\[H_0: \theta = \theta_0\]
  </li>
  <li>
\[H_1: \theta = \theta_1\]
  </li>
</ul>

<p>Where \(\theta_1 &gt; \theta_1\).</p>

<p>Then the log-likelihood function (LLF) for one sample is</p>

\[\begin{aligned}
\log{\Lambda\left(x\right)} &amp;= \log{ \frac{1}{\theta_1}e^-x/\theta_1  }{ \frac{1}{\theta_0}e^-x/\theta_0  } 
&amp;= -\log{\frac{\theta_1}{\theta_0}} + \frac{\theta_1 - \theta_0}{\theta_1\theta_0}x
\end{aligned}\]

<p>The cumulative sum of the LLFs for all x is</p>

\[S_n = \sum_n \log{\Lambda\left(x_i\right)} = -n\log{\frac{\theta_1}{\theta_0}} + \frac{\theta_1 - \theta_0}{\theta_1\theta_0}\sum_n x_i\]

<p>Accordingly, the stopping rule is:</p>

\[a &lt;  -n\log{\frac{\theta_1}{\theta_0}} + \frac{\theta_1 - \theta_0}{\theta_1\theta_0}\sum_n x_i &lt; b\]

<p>After re-arranging we finally find</p>

\[a + n\log{\frac{\theta_1}{\theta_0}} &lt; \frac{\theta_1 - \theta_0}{\theta_1\theta_0}\sum_n x_i &lt; b + n\log{\frac{\theta_1}{\theta_0}}\]

<p>The thresholds are simply two parallel lines with slope \(\log{\frac{\theta_1}{\theta_0}}\). Sampling should stop when the sum of the samples makes an excursion outside the continue-sampling region.</p>

<h3 id="example-binomial-distribution">Example: Binomial Distribution</h3>

<h3 id="1-likelihood-ratio-for-bernoulli-distribution">1. Likelihood Ratio for Bernoulli Distribution</h3>

<p>For a Bernoulli trial, \(X \in \{0, 1\}\) with probability \(\theta\) for success (\(\theta = 1\)) and \(1 - \theta\) for failure (\(\theta = 0\)).</p>

<ul>
  <li>
    <p>Under hypothesis \(H_1\) with parameter \(\theta_1\):<br />
\(P(X = x | \theta_1) = \theta_1^x (1 - \theta_1)^{1 - x}\)</p>
  </li>
  <li>
    <p>Under hypothesis \(H_0\) with parameter \(\theta_0\):<br />
\(P(X = x | \theta_0) = \theta_0^x (1 - \theta_0)^{1 - x}\)</p>
  </li>
</ul>

<p>The likelihood ratio is:
\(\Lambda(x) = \frac{P(X = x | \theta_1)}{P(X = x | \theta_0)} = \frac{\theta_1^x (1 - \theta_1)^{1 - x}}{\theta_0^x (1 - \theta_0)^{1 - x}}\)</p>

<h3 id="2-log-likelihood-ratio">2. Log-Likelihood Ratio</h3>

<p>The log-likelihood ratio is:
\(\log \Lambda(x) = \log \left( \frac{\theta_1^x (1 - \theta_1)^{1 - x}}{\theta_0^x (1 - \theta_0)^{1 - x}} \right)\)</p>

<p>Breaking this into cases for \(x = 0\) and \(x = 1\):</p>

<p>If \(x = 1\):</p>

\[\log \Lambda(1) = \log \frac{\theta_1}{\theta_0}\]

<p>If \(x = 0\):</p>

\[\log \Lambda(0) = \log \frac{1 - \theta_1}{1 - \theta_0}\]

<p>Thus, the general form for \(x\) is:</p>

\[\log \Lambda(x) = x \log \frac{\theta_1}{\theta_0} + (1 - x) \log \frac{1 - \theta_1}{1 - \theta_0}\]

<h3 id="3-cumulative-log-likelihood-for-n-observations">3. Cumulative Log-Likelihood for \(n\) Observations</h3>

<p>Now we calculate the cumulative log-likelihood ratio for ( n ) independent observations ( x_1, x_2, \ldots, x_n ):
\(S_n = \log \frac{\theta_1}{\theta_0} \sum_{i=1}^{n} x_i + \log \frac{1 - \theta_1}{1 - \theta_0} \sum_{i=1}^{n} (1 - x_i)\)</p>

<p>This simplifies to:
[
S_n = \log \frac{\theta_1}{\theta_0} \sum_{i=1}^{n} x_i + \log \frac{1 - \theta_1}{1 - \theta_0} \sum_{i=1}^{n} (1 - x_i)
]</p>

<h3 id="4-stopping-rule">4. Stopping Rule</h3>

<p>The stopping rule in this context is when the cumulative sum ( S_n ) crosses specific thresholds. The inequality becomes:
\(a &lt; \log \frac{\theta_1}{\theta_0} \sum_{i=1}^{n} x_i + \log \frac{1 - \theta_1}{1 - \theta_0} \sum_{i=1}^{n} (1 - x_i) &lt; b\)</p>

<p>Rearranging this gives:
\(a - n \log \frac{1 - \theta_1}{1 - \theta_0} &lt; \log \frac{\theta_1}{\theta_0} \sum_{i=1}^{n} x_i &lt; b - n \log \frac{1 - \theta_1}{1 - \theta_0}\)</p>

<h3 id="5-interpretation">5. Interpretation</h3>

<p>In this case, the thresholds are two parallel lines with slopes based on the log-ratios \(\log \frac{\theta_1}{\theta_0}\) and \(\log \frac{1 - \theta_1}{1 - \theta_0}\). The sampling process stops when the sum of the observed successes \(\sum x_i\) exits the continuation region bounded by these two lines.</p>

<p>We can summarise this in the following algorithm:</p>

<p>Set \(LR \leftarrow 1\) and \(j \leftarrow 0\)</p>

<ol>
  <li>Increment \(j\)</li>
  <li>If \(𝑋_j=1\) then set \(LR \leftarrow LR \frac{\theta_1}{\theta_0}\)</li>
  <li>If \(𝑋_j=0\) then set \(LR \leftarrow LR \frac{(1−\theta_1)}{(1−\theta_0)}\)</li>
</ol>

<p>What’s \(LR\) at stage 𝑚? Let \(T_m≡ \sum_{j=1}^m 𝑋_j\) then:</p>

\[\frac{\theta_{1𝑚}}{\theta_{0m}} = \frac{\theta_1^{𝑇_𝑚}(1−\theta_1)^{𝑚−𝑇_𝑚}}{\theta_0^{𝑇_𝑚}(1−\theta_0)^{𝑚−𝑇_𝑚}}\]

<p>This is the ratio of binomial probability when \(\theta=\theta_1\) to binomial probability when \(\theta=\theta_0\) (the binomial coefficients in the numerator and denominator cancel). It simplifies further to</p>

\[\frac{\theta_{1𝑚}}{\theta_{0𝑚}}=\left(\frac{(\theta_0}{\theta_1}\right)^{𝑇_m}\left(\frac{1−\theta_0}/{1−\theta_1})\right)^{𝑚−𝑇_𝑚}\]

<p>We conclude \(\theta &gt; \theta_0\) if</p>

\[\frac{\theta_1m}{\theta_0m} \geq \frac{1-\beta}{\alpha}\]

<p>And we conclude \(\theta &lt; \theta_0\) if</p>

\[\frac{\theta_1m}{\theta_0m} \geq \frac{\beta}{1-\alpha}\]

<p>Otherwise, we draw again.</p>

<p>The SPRT approximately minimizes the expected sample size when \(\theta &gt; \theta_0\) or \(\theta &gt; \theta_1\). For values in \(\left(\theta_1,\theta_0\right)\), it can have larger sample sizes than fixed-sample-size tests.</p>

<h3 id="example-normal-distribution">Example: Normal Distribution</h3>

<p>Consider the Normal distribution:</p>

\[f\left(x; \theta\right) = \frac{1}{\sqrt{2\pi}}e^\left(-\left(x-\theta\right)^2/2\right)\]

<p>The hypotheses are</p>

<ul>
  <li>
\[H_0: \theta = \theta_0\]
  </li>
  <li>
\[H_1: \theta = \theta_1\]
  </li>
</ul>

<p>Where \(\theta_1 &gt; \theta_1\).</p>

<p>Then the log-likelihood function (LLF) for one sample is</p>

\[\begin{aligned}
\log{\Lambda\left(x\right)} &amp;= \log{ \frac{1}{\sqrt{2\pi}}e^\left(-\left(x-\theta_1\right)^2/2\right)  }{ \\frac{1}{\sqrt{2\pi}}e^\left(-\left(x-\theta_0\right)^2/2\right)  } 
&amp;= -\frac{1}{2}\log{\frac{\theta_1}{\theta_0}} + \frac{\theta_1 - \theta_0}{2\theta_1\theta_0}x_i^2 - \frac{\theta_1 - \theta_0}{2}
\end{aligned}\]

<p>The cumulative sum of the LLFs for all x is</p>

\[S_n = \sum_n \log{\Lambda\left(x_i\right)} = -n\log{\frac{\theta_1}{\theta_0}} + \frac{\theta_1 - \theta_0}{\theta_1\theta_0}\sum_n x_i\]

<p>Accordingly, the stopping rule is:</p>

\[a &lt;  -n\log{\frac{\theta_1}{\theta_0}} + \frac{\theta_1 - \theta_0}{\theta_1\theta_0}\sum_n x_i &lt; b\]

<p>After re-arranging we finally find</p>

\[a + n\log{\frac{\theta_1}{\theta_0}} &lt; \frac{\theta_1 - \theta_0}{\theta_1\theta_0}\sum_n x_i &lt; b + n\log{\frac{\theta_1}{\theta_0}}\]

<p>The thresholds are simply two parallel lines with slope \(\log{\frac{\theta_1}{\theta_0}}\). Sampling should stop when the sum of the samples makes an excursion outside the continue-sampling region.</p>

<h2 id="the-mixture-sequential-probability-ratio-test-msprt">The Mixture Sequential Probability Ratio Test (mSPRT)</h2>

<p>The main limitation of the Sequential Probability Ratio Test (SPRT) is its requirement for specifying an explicit alternative hypothesis, which might not always align with the goal of merely rejecting a null hypothesis. In contrast, the modified Sequential Probability Ratio Test (mSPRT) offers flexibility in determining sample sizes at the start of an experiment, unlike the traditional SPRT, where sample size calculations are not feasible. Consequently, parameters such as \(N\), \(\alpha\), and \(\beta\) are fixed at the outset of an experiment.</p>

<p>The mixture Sequential Probability Ratio Test (mSPRT) amends these limitations. The test is defined by a “mixing” distribution \(H\) over a parameter space \(\Theta\), where \(H\) is assumed to have a density \(h\) that is positive everywhere. Utilizing \(H\), we first compute the following mixture of likelihood ratios against the null hypothesis \(\theta = \theta_0\):</p>

\[\Lambda_n(s_n) = \int_{\Theta} \left(\frac{f_{\theta}(s_n)}{f_{\theta_0}(s_n)}\right)^n dH(\theta).\]

<p>The mSPRT is parameterized by a mixing distribution \(H\) over \(\Theta\), which is restricted to have an everywhere continuous and positive derivative. Given an observed sample average \(s_n\) up to time \(n\), the likelihood ratio of \(\theta\) against \(\theta_0\) is \(\left(\frac{f_{\theta}(s_n)}{f_{\theta_0}(s_n)}\right)^n\). Thus, we define the mixture likelihood ratio with respect to \(H\) as:</p>

\[\Lambda_n(s_n) = \int_{\Theta} \left(\frac{f_{\theta}(s_n)}{f_{\theta_0}(s_n)}\right)^n dH(\theta).\]

<h3 id="application-to-normal-data">Application to Normal Data</h3>

<p>Considering normal data, for any \(\mu_A\) and \(\mu_B\), the difference \(Z_n = Y_n - X_n\) follows a normal distribution \(\sim N(\theta, 2\sigma^2)\). We can apply the one-variation mSPRT to the sequence \(\{Z_n\}\), leading to the following definition:</p>

\[\sqrt{\frac{2\sigma^2}{2\sigma^2 + n\tau^2}} \exp{\left(\frac{n^2\tau^2\left(X_n - Y_n - \theta_0\right)^2}{4\sigma^2\left(2\sigma^2 + n\tau^2\right)}\right)}.\]

<p>Here’s a small simulation:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_mSPRT</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">sigma_squared</span><span class="p">,</span> <span class="n">tau_squared</span><span class="p">,</span> <span class="n">theta_0</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_data</span><span class="p">)</span>
    <span class="n">y_mean</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_data</span><span class="p">)</span>
    <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span>
    <span class="n">lambda_n</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_squared</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_squared</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">tau_squared</span><span class="p">))</span> <span class="o">*</span> \
               <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="n">tau_squared</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_mean</span> <span class="o">-</span> <span class="n">x_mean</span> <span class="o">-</span> <span class="n">theta_0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">sigma_squared</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_squared</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">tau_squared</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">lambda_n</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Parameters for synthetic data generation
</span><span class="n">mu_X</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">mu_Y</span> <span class="o">=</span> <span class="mi">3</span>  
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.0</span>  
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">100</span>  

<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu_X</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
<span class="n">y_data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu_Y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sigma_squared</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">tau_squared</span> <span class="o">=</span> <span class="mi">1</span>  
<span class="n">theta_0</span> <span class="o">=</span> <span class="mi">0</span>  

<span class="n">msprt_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">lambda_n</span> <span class="o">=</span> <span class="n">compute_mSPRT</span><span class="p">(</span><span class="n">y_data</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">x_data</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">sigma_squared</span><span class="p">,</span> <span class="n">tau_squared</span><span class="p">,</span> <span class="n">theta_0</span><span class="p">)</span>
    <span class="n">msprt_values</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">lambda_n</span><span class="p">)</span>

<span class="n">p_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lambda_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">msprt_values</span><span class="p">):</span>
    <span class="n">p_values</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">p_values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">lambda_val</span><span class="p">))</span>

<span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_values</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s">'Always Valid p-values'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Number of Observations'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'p-value'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Always Valid p-values Over Time'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">msprt_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'likelihood'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Number of Observations'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'likelihood'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Likelihood Over Time'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

        </div>
        
    </div>
</body>
</html>